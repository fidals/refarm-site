version: '2'

services:

  app:
    build:
      context: ..
      dockerfile: docker/Dockerfile.python
    image: fidals/rf:test
    working_dir: $SRC_DIR
    environment:
      - DATABASE_URL=postgres://$DB_USER:$DB_PASS@db/$DB_NAME
    depends_on:
      - db
    links:
      - db
    volumes:
      - ./../:$SRC_DIR  # code volume
    command: python manage.py test

  db:
    image: postgres:9.5
    restart: always
    environment:
      POSTGRES_DB: $DB_NAME
      POSTGRES_PASSWORD: $DB_PASS

  pdd:
    image: fidals/pdd-ci
    working_dir: $SRC_DIR
    volumes:
      - ./../:$SRC_DIR
    entrypoint:
      - pdd
      - --exclude=**/vendors/*
