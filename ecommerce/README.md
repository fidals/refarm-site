# Ecommerce arch

# Глоссарий

**Вьюшка (View)** - часть архитектурного концепта MTV (Model, Template, View). Вьюшка принимает http-запрос с его параметрами и превращают этот запрос в ответ. Для этого обычно ходит в базу.

*Пример*

*Во вьюшку прилетел запрос с путём: /catalog/products/3497/. Из этого запроса вьюшка понимает, что нужен продукт (products) с номером id=3497, и искать его нужно в каталоге (catalog). Для этого вьюшка идёт в базу, достаёт данные этого продукта, втыкает их в html-шаблон и возвращает в качестве ответа готовый html.*

*[Результат работы вьюшки в чистом виде.](https://www.shopelectro.ru/catalog/products/3497/.)*

# Общее

Ecommerce – python-модуль приложения Refarm-site.

Функциональность Ecommerce позволяет:
* работать с базой товаров:
  * скачать выгрузку базы товаров и парсить затронутые (добавленные или изменённые в 1С) продукты и их характеристики;
  * добавить/удалить/обновить затронутые продукты и их характеристики;
  * обновить прайс-листы:
    * для Яндекс.Маркета;
    * в формате Excel;
* работать с корзиной:
  * добавить товары;
  * хранить содержимое корзины между http-сессиями;
  * превратить содержимое корзины в заказ;
  * следить за скидками;
* работать с заказом:
  * через Яндекс.Кассу:
    * формировать данные для оплаты;
    * проверять платежи;
* рассылать почтовые уведомления после совершённого заказа:
  * менеджеру магазина;
  * покупателю;
  * в базу для резервирования.

# Код

Универсальные сущности лежат в refarm-site/ecommerce. Чтобы их использовать, мы наследуемся от них в своём проекте и расширяем их.

*Примеры*

*1. В SE частично переопределяем базовую модель корзины - используем пересчёт цены в зависимости от объёма закупки: https://github.com/fidals/shopelectro/blob/master/shopelectro/cart.py.*

*2. В SE в базовую модель заказа добавляем несколько полей:
https://github.com/fidals/shopelectro/blob/master/shopelectro/models.py#L114.*

*3. В SE переопределяем шаблон пиёсьма рассылки:
https://github.com/fidals/shopelectro/blob/master/templates/ecommerce/order/email.html.*

Вьюшки:
* [стандартные для моделей заказа и корзины](https://github.com/fidals/refarm-site/blob/master/ecommerce/views.py);
* [формирующая данные для оплаты через Яндекс.Кассу](https://github.com/fidals/shopelectro/blob/master/shopelectro/views/ecommerce.py#L93) (этап №2 из [схемы платежа](https://tech.yandex.ru/money/doc/payment-solution/payment-process/payments-receipt-docpage/));
* сервисная, для проверки платежей Яндекс.Кассы (этап №5 из [схемы платежа](https://tech.yandex.ru/money/doc/payment-solution/payment-process/payments-receipt-docpage/)).
